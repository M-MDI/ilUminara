<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/navbar.css">
    <link rel="stylesheet" href="/assets/css/login.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/error.css">
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <header>
        <a href="/">
            <p>
                <img class="img-01" src="/assets/images/01.png" alt="01">
                <span class="forum-title">forum</span>
            </p>
        </a>
        {{ if .IsAuthenticated}}
        <div class="header-user">
            <span class="header-username"><i class="fa-regular fa-user"></i>{{.UserName}}</span>
            <form action="/logout" method="post">
                <button class="logout-link">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </button>
            </form>
        </div>
        {{else}}
        <a href="/login" class="login-link">Log in
            <i class="fa-solid fa-right-to-bracket"></i>
        </a>
        {{end}}
    </header>

    <nav>
        <ul class="nav-list">
            <li><a href="/"><i class="fa-solid fa-house"></i>Home</a></li>
            {{ if .IsAuthenticated}}
            <li><a href="/mycreatedposts"><i class="fa-regular fa-star"></i></i>My Posts</a></li>
            <li><a href="/mylikedposts"><i class="fa-regular fa-heart"></i></i>Liked Posts</a></li>
            {{end}}
            <li>
                <span class="categories-title"><i class="fa-solid fa-list"></i>Categories</span>
                {{if .Categories}}
                <ul class="categories-list">
                    {{range .Categories}}
                    <li><a href="/category/{{.ID}}">#{{.Label}} ({{.PostsCount}})</a></li>
                    {{end}}
                </ul>
                {{else}}
                <p class="no-categories">No categories available.</p>
                {{end}}
            </li>
        </ul>
    </nav>

    <!-- mobile nav -->
    <nav class="mobile-nav">
        <button class="close-nav" onclick="closeMobileNav()">
            <i class="fa-solid fa-xmark"></i>
        </button>
        <ul class="nav-list">
            <li><a href="/"><i class="fa-solid fa-house"></i>Home</a></li>
            {{ if .IsAuthenticated}}
            <li><a href="/mycreatedposts"><i class="fa-regular fa-star"></i></i>My Posts</a></li>
            <li><a href="/mylikedposts"><i class="fa-regular fa-heart"></i></i>Liked Posts</a></li>
            {{end}}
            <li>
                <span class="categories-title"><i class="fa-solid fa-list"></i>Categories</span>
                {{if .Categories}}
                <ul class="categories-list">
                    {{range .Categories}}
                    <li><a href="/category/{{.ID}}">#{{.Label}} ({{.PostsCount}})</a></li>
                    {{end}}
                </ul>
                {{else}}
                <p class="no-categories">No categories available.</p>
                {{end}}
            </li>
        </ul>
    </nav>

    <div class="container">
        <!-- Register Page -->
        <div class="register-page">
            <div class="register-card">
                <h1>Register</h1>
                <div method="post" class="register-form">
                    <input id="email" type="text" name="email" class="register-input" placeholder="email ">
                    <input id="username" type="text" name="username" class="register-input" placeholder="username">
                    <input id="password" type="password" name="password" class="register-input" placeholder="********">
                    <input id="password-confirmation" type="password" name="password-confirmation" class="register-input" placeholder="********">
                    <div class="errorarea"></div>
                    <button onclick="register()" type="submit" class="register-submit">Register<i class="fa-solid fa-user-plus"></i></button>
                </div>
                <span class="form-line"></span>
                <p class="form-second-option">Already registered? <a href="/login">Log in</a></p>
            </div>
        </div>

        <!-- Post Page -->
        <div class="post-detail">
            <div class="post">
                <div class="post-body">
                    <p class="post-title">{{.Data.Post.Title}} </p>
                    <div class="post-header">
                        <p class="post-user">{{.Data.Post.UserName}} </p>
                        <span></span>
                        <p class="post-time" data-timestamp="{{.Data.Post.CreatedAt}}">{{.Data.Post.CreatedAt}}</p>
                    </div>
                    <p class="post-content">{{.Data.Post.Content}} </p>
                    <div class="post-categories">
                        {{range .Data.Post.Categories}}
                        <span class="post-category">#{{.}}</span>
                        {{end}}
                    </div>
                </div>
                <div class="post-footer">
                    <button id="likescount{{.Data.Post.ID}}" onclick="postreaction('{{.Data.Post.ID}}','like')"
                        class="post-like post-footer-hover"><i
                            class="fa-regular fa-thumbs-up"></i>{{.Data.Post.Likes}}</button>
                    <button id="dislikescount{{.Data.Post.ID}}" onclick="postreaction('{{.Data.Post.ID}}','dislike')"
                        class="post-dislike post-footer-hover"><i
                            class="fa-regular fa-thumbs-down"></i>{{.Data.Post.Dislikes}}</button>
                    <span class="post-comments"><i class="fa-regular fa-comment"></i>{{.Data.Post.Comments}}</span>
                </div>
                <span style="color:red; border: none;" id="errorlogin{{.Data.Post.ID}}"></span>
            </div>
            <div class="comment-add">
                <textarea name="postid" hidden>{{.Data.Post.ID}}</textarea>
                <textarea id="comment-content" name="comment" placeholder="Add a comment..." required></textarea>
                <button onclick="addcomment('{{.Data.Post.ID}}')" >Comment</button>
            </div>
            <h2 style="padding-left: 10px;">Comments: </h2>
            <div class="comments">
                {{range .Data.Comments}}
                <div class="comment">
                    <div class="comment-header">
                        <p class="comment-user">{{.UserName}}</p>
                        <span></span>
                        <p class="comment-time" data-timestamp="{{.CreatedAt}}">{{.CreatedAt}}</p>
                    </div>
                    <div class="comment-body">
                        <p class="comment-content">{{.Content}} </p>
                    </div>
                    <div class="comment-footer">
                        <button id="commentlikescount{{.ID}}" onclick="commentreaction('{{.ID}}','like')"
                            class="comment-like"><i class="fa-regular fa-thumbs-up"></i>{{.Likes}}</button>
                        <button id="commentdislikescount{{.ID}}" onclick="commentreaction('{{.ID}}','dislike')"
                            class="comment-dislike"><i class="fa-regular fa-thumbs-down"></i>{{.Dislikes}}</button>
                    </div>
                    <span style="color:red" id="commenterrorlogin{{.ID}}"></span>
                </div>
                {{end}}
            </div>
        </div>

        <!-- Post Form Page -->
        <div class="create-post">
            <h1>Create a New Post</h1>
            <div class="create-post-fields">
                <label>Title* <span class="max-char">(max: 100 char)</span></label>
                <input name="title" class="create-post-title" placeholder="Enter your post title here..." />
            </div>
            <div class="create-post-fields">
                <label>Categories*</label>
                <div class="create-post-categories">
                    <div class="selected-categories"></div>
                    <select id="categories-select">
                        <option selected disabled>Select a category</option>
                        {{range .Categories}}
                        <option value='{"id":"{{.ID}}","label":"{{.Label}}"}'>{{.Label}}</option>
                        {{end}}
                    </select>
                </div>
            </div>
            <div class="create-post-fields">
                <label>Content* <span class="max-char">(max: 1000 char)</span></label>
                <textarea class="content" name="content" placeholder="What's on your mind?"></textarea>
            </div>
            <span class="errorarea"></span>
            <button id="create-post-btn" onclick="CreatPost()">
                Publish Post
                <i class="fa-regular fa-calendar-plus" id="publish-post-icon"></i>
                <i class="fa-solid fa-circle-notch fa-spin" id="publish-post-circle"></i>
            </button>
        </div>

        <!-- Login Page -->
        <div class="login-page">
            <div class="login-card">
                <h1>Log in</h1>
                <div class="login-form">
                    <input type="text" name="username" id="username" class="login-input" placeholder="email or username">
                    <input type="password" name="password" id="password" class="login-input" placeholder="********">
                    <span class="errorarea" style="color: rgb(255, 0, 0);"></span>
                    <button onclick="login()" class="login-submit">Log in<i class="fa-solid fa-right-to-bracket"></i></button>
                </div>
                <span class="form-line"></span>
                <p class="form-second-option">New to 01Forum? <a href="/register">Register</a></p>
            </div>
        </div>

        <!-- Home Page -->
        <div class="posts">
            <div class="posts-header">
                <button class="nav-button" onclick="displayMobileNav()">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <a href="/post/create" class="create-post-link">
                    <i class="fa-solid fa-plus"></i>
                    Create post
                </a>
            </div>
            {{if .Data}}
            {{range .Data}}
            <div class="post">
                <div class="post-body">
                    <a href="/post/{{.ID}}" class="post-title">{{.Title}}</a>
                    <div class="post-header">
                        <p class="post-user">{{.UserName}} </p>
                        <span></span>
                        <p class="post-time" data-timestamp="{{.CreatedAt}}">{{.CreatedAt}}</p>
                    </div>
                    <p class="post-content" id="post-content-home">{{.Content}} </p>
                    <div class="post-categories">
                        {{range .Categories}}
                        <span class="post-category">#{{.}}</span>
                        {{end}}
                    </div>
                </div>
                <div class="post-footer">
                    <button id="likescount{{.ID}}" onclick="postreaction('{{.ID}}','like')"
                        class="post-like post-footer-hover"><i class="fa-regular fa-thumbs-up"></i>{{.Likes}}</button>
                    <button id="dislikescount{{.ID}}" onclick="postreaction('{{.ID}}','dislike')"
                        class="post-dislike post-footer-hover"><i
                            class="fa-regular fa-thumbs-down"></i>{{.Dislikes}}</button>
                    <a href="/post/{{.ID}}" class="post-comments post-footer-hover">
                        <i class="fa-regular fa-comment"></i>{{.Comments}}
                    </a>
                </div>
                <span style="color:red" id="errorlogin{{.ID}}"></span>
            </div>
            {{end}}
            {{else}}
            <p class="no-posts">No posts available to display !</p>
            {{end}}
        </div>
        <div class="pagination">
            <a onclick="pagination('back', `{{if .Data}}true{{end}}`)" class="back" href="#">&laquo;
                Back</a>
            <span class="currentpage">1</span>
            <a onclick="pagination('next', `{{if .Data}}true{{end}}`)" class="next" href="#">Next
                &raquo;</a>
        </div>
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const path = window.location.pathname
            let page = 1

            if (!isNaN(parseInt(urlParams.get('PageID')))) {
                page = parseInt(urlParams.get('PageID'))
            }
            fetch(path + "?PageID=" + (page + 1)).then(response => {
                if (response.status != 200) {
                    const nextbtn = document.querySelector(".next")
                    nextbtn.outerHTML = `<a class="next" style="cursor : not-allowed; color : grey;">Next &raquo;</a>`
                }
            })

            if (urlParams.get('PageID') <= 1) {
                const backbtn = document.querySelector(".back")
                backbtn.outerHTML = `<a class="back" style="cursor : not-allowed; color : grey;">&laquo; Back</a>`
            }
            document.querySelector(".currentpage").innerText = urlParams.get('PageID') > 0 ? urlParams.get('PageID') : 1
        </script>
    </div>

    <!-- Error Page -->
    <div class="error-page">
        <div class="error-card">
            <h1>{{.Data.Code}}</h1>
            <p>{{.Data.Message}}</p>
            <a href="/"><i class="fa-solid fa-circle-left"></i> Back Home</a>
        </div>
    </div>

    <div class="footer-container">
        <div class="hidden-footer"></div>
        <footer>
            <div>
                <span>01</span>Forum copyright © 2024
            </div>
            <div class="footer-team">
                <a href="https://github.com/M-MDI"><img src="/assets/images/github.png" alt="github-logo" /> Mehdi
                    Moulabbi</a>
            </div>
        </footer>
    </div>
    <script src="/assets/js/index.js"></script>
</body>
</html>